<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart City 3D View - AI Hackathon Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.4/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .nav-buttons {
            margin-top: 10px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            margin-right: 10px;
            border-radius: 20px;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.6);
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
        }

        .control-panel {
            position: absolute;
            top: 120px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            width: 280px;
        }

        .control-panel h3 {
            margin-bottom: 15px;
            color: #FFD700;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 10px;
        }

        .control-group button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .control-group button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .control-group button.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            max-width: 300px;
        }

        .legend {
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            z-index: 1001;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèôÔ∏è Smart City 3D Visualization</h1>
        <div class="nav-buttons">
            <a href="/dashboard" class="nav-btn">üìä Dashboard</a>
            <a href="/3d-view" class="nav-btn active">üèôÔ∏è 3D View</a>
        </div>
    </div>

    <div id="canvas-container"></div>

    <div class="control-panel">
        <h3>üéõÔ∏è View Controls</h3>
        
        <div class="control-group">
            <label>Camera Angle</label>
            <button onclick="setCameraView('aerial')">Aerial</button>
            <button onclick="setCameraView('street')">Street</button>
            <button onclick="setCameraView('overview')">Overview</button>
        </div>

        <div class="control-group">
            <label>Show/Hide Layers</label>
            <button id="traffic-toggle" class="active" onclick="toggleLayer('traffic')">Traffic</button>
            <button id="environment-toggle" class="active" onclick="toggleLayer('environment')">Air Quality</button>
            <button id="infrastructure-toggle" class="active" onclick="toggleLayer('infrastructure')">Infrastructure</button>
        </div>

        <div class="control-group">
            <label>Animation Speed</label>
            <input type="range" id="animation-speed" min="0.1" max="2" step="0.1" value="1" onchange="updateAnimationSpeed(this.value)">
            <small>Current: <span id="speed-value">1.0</span>x</small>
        </div>

        <div class="control-group">
            <button onclick="resetView()">üîÑ Reset View</button>
            <button onclick="toggleFullscreen()">üîç Fullscreen</button>
        </div>
    </div>

    <div class="info-panel">
        <h3>üìä Live Data</h3>
        <div id="live-stats">
            <p>Traffic Sensors: <span id="traffic-count">0</span></p>
            <p>Air Quality Stations: <span id="air-count">0</span></p>
            <p>Infrastructure Assets: <span id="infra-count">1</span></p>
            <p>Active Alerts: <span id="alert-count">0</span></p>
        </div>

        <div class="legend">
            <h4>Legend</h4>
            <div class="legend-item">
                <div class="legend-color" style="background: #4CAF50;"></div>
                <span>Normal/Good</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF9800;"></div>
                <span>Warning/Fair</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #F44336;"></div>
                <span>Critical/Poor</span>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Loading 3D City Model...</h2>
            <p>Initializing visualization engine</p>
        </div>
    </div>

    <div id="tooltip" class="tooltip" style="display: none;"></div>

    <script>
        // Global variables
        let scene, camera, renderer, controls;
        let trafficObjects = [];
        let environmentObjects = [];
        let infrastructureObjects = [];
        let animationSpeed = 1.0;
        let showLayers = {
            traffic: true,
            environment: true,
            infrastructure: true
        };

        // Socket.IO connection
        const socket = io();
        
        // Data storage
        let trafficData = {};
        let airQualityData = [];
        let infrastructureData = {};
        let alerts = [];

        // Initialize 3D scene
        function init3DScene() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x001122);

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(50, 50, 50);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(100, 100, 50);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // Create city base
            createCityBase();

            // Hide loading overlay
            document.getElementById('loading-overlay').style.display = 'none';

            // Start animation loop
            animate();
        }

        function createCityBase() {
            // Ground plane
            const groundGeometry = new THREE.PlaneGeometry(200, 200);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Grid
            const gridHelper = new THREE.GridHelper(200, 20, 0x555555, 0x333333);
            scene.add(gridHelper);

            // Create some basic city buildings
            createBuildings();
        }

        function createBuildings() {
            const buildingPositions = [
                { x: -30, z: -30, height: 20 },
                { x: -10, z: -30, height: 35 },
                { x: 10, z: -30, height: 15 },
                { x: 30, z: -30, height: 25 },
                { x: -30, z: 30, height: 30 },
                { x: 10, z: 30, height: 40 },
                { x: 30, z: 30, height: 18 }
            ];

            buildingPositions.forEach(pos => {
                const geometry = new THREE.BoxGeometry(8, pos.height, 8);
                const material = new THREE.MeshLambertMaterial({ 
                    color: new THREE.Color().setHSL(Math.random() * 0.1 + 0.5, 0.5, 0.5) 
                });
                const building = new THREE.Mesh(geometry, material);
                building.position.set(pos.x, pos.height / 2, pos.z);
                building.castShadow = true;
                scene.add(building);
            });
        }

        function updateTrafficVisualization() {
            // Clear existing traffic objects
            trafficObjects.forEach(obj => scene.remove(obj));
            trafficObjects = [];

            if (!showLayers.traffic) return;

            const trafficPositions = [
                { x: -40, z: 0 },   // TS001
                { x: 0, z: -40 },   // TS002
                { x: 0, z: 0 },     // TS003 (bridge)
                { x: 40, z: 0 },    // TS004
                { x: 0, z: 40 }     // TS005
            ];

            Object.entries(trafficData).forEach(([sensorId, data], index) => {
                if (index >= trafficPositions.length) return;

                const pos = trafficPositions[index];
                const congestionLevel = data.congestion_level || 0;
                
                // Traffic light pole
                const poleGeometry = new THREE.CylinderGeometry(0.2, 0.2, 8);
                const poleMaterial = new THREE.MeshLambertMaterial({ color: 0x666666 });
                const pole = new THREE.Mesh(poleGeometry, poleMaterial);
                pole.position.set(pos.x, 4, pos.z);
                
                // Traffic light color based on congestion
                const lightColor = congestionLevel < 0.3 ? 0x00ff00 : 
                                  congestionLevel < 0.7 ? 0xffff00 : 0xff0000;
                
                const lightGeometry = new THREE.SphereGeometry(1);
                const lightMaterial = new THREE.MeshBasicMaterial({ color: lightColor });
                const light = new THREE.Mesh(lightGeometry, lightMaterial);
                light.position.set(pos.x, 8, pos.z);
                
                // Add glow effect
                const glowMaterial = new THREE.MeshBasicMaterial({
                    color: lightColor,
                    transparent: true,
                    opacity: 0.3
                });
                const glow = new THREE.Mesh(new THREE.SphereGeometry(1.5), glowMaterial);
                glow.position.copy(light.position);
                
                // Vehicle flow indicators
                const vehicleCount = Math.min(data.vehicle_count || 0, 20);
                for (let i = 0; i < vehicleCount / 5; i++) {
                    const vehicleGeometry = new THREE.BoxGeometry(1, 0.5, 2);
                    const vehicleMaterial = new THREE.MeshLambertMaterial({ color: 0x4444ff });
                    const vehicle = new THREE.Mesh(vehicleGeometry, vehicleMaterial);
                    
                    const angle = (i / (vehicleCount / 5)) * Math.PI * 2;
                    const radius = 5;
                    vehicle.position.set(
                        pos.x + Math.cos(angle) * radius,
                        0.25,
                        pos.z + Math.sin(angle) * radius
                    );
                    vehicle.rotation.y = angle;
                    
                    trafficObjects.push(vehicle);
                    scene.add(vehicle);
                }
                
                pole.userData = { type: 'traffic', id: sensorId, data: data };
                light.userData = { type: 'traffic', id: sensorId, data: data };
                
                trafficObjects.push(pole, light, glow);
                scene.add(pole, light, glow);
            });
        }

        function updateEnvironmentVisualization() {
            // Clear existing environment objects
            environmentObjects.forEach(obj => scene.remove(obj));
            environmentObjects = [];

            if (!showLayers.environment) return;

            const envPositions = [
                { x: -20, z: -20 },
                { x: 20, z: -20 },
                { x: -20, z: 20 },
                { x: 20, z: 20 },
                { x: 0, z: 0 }
            ];

            airQualityData.forEach((station, index) => {
                if (index >= envPositions.length) return;

                const pos = envPositions[index];
                
                // Air quality monitor
                const monitorGeometry = new THREE.BoxGeometry(2, 4, 2);
                const pm25Status = station.pm25 > 25 ? 'danger' : station.pm25 > 15 ? 'warning' : 'normal';
                const monitorColor = pm25Status === 'danger' ? 0xff0000 : 
                                   pm25Status === 'warning' ? 0xffaa00 : 0x00ff00;
                
                const monitorMaterial = new THREE.MeshLambertMaterial({ color: monitorColor });
                const monitor = new THREE.Mesh(monitorGeometry, monitorMaterial);
                monitor.position.set(pos.x, 2, pos.z);
                
                // Pollution cloud effect
                const cloudGeometry = new THREE.SphereGeometry(3, 8, 8);
                const cloudMaterial = new THREE.MeshBasicMaterial({
                    color: monitorColor,
                    transparent: true,
                    opacity: station.pm25 / 100
                });
                const cloud = new THREE.Mesh(cloudGeometry, cloudMaterial);
                cloud.position.set(pos.x, 6, pos.z);
                
                monitor.userData = { type: 'environment', id: station.district, data: station };
                cloud.userData = { type: 'environment', id: station.district, data: station };
                
                environmentObjects.push(monitor, cloud);
                scene.add(monitor, cloud);
            });
        }

        function updateInfrastructureVisualization() {
            // Clear existing infrastructure objects
            infrastructureObjects.forEach(obj => scene.remove(obj));
            infrastructureObjects = [];

            if (!showLayers.infrastructure) return;

            // Bridge structure
            const bridgeGeometry = new THREE.BoxGeometry(80, 2, 8);
            const bridgeStatus = infrastructureData.overall_status || 'unknown';
            const bridgeColor = bridgeStatus === 'good' ? 0x4CAF50 : 
                               bridgeStatus === 'fair' ? 0xFF9800 : 
                               bridgeStatus === 'poor' ? 0xF44336 : 0x666666;
            
            const bridgeMaterial = new THREE.MeshLambertMaterial({ color: bridgeColor });
            const bridge = new THREE.Mesh(bridgeGeometry, bridgeMaterial);
            bridge.position.set(0, 10, 0);
            
            // Bridge supports
            const supportGeometry = new THREE.CylinderGeometry(1, 1, 10);
            const supportMaterial = new THREE.MeshLambertMaterial({ color: bridgeColor });
            
            [-30, -10, 10, 30].forEach(x => {
                const support = new THREE.Mesh(supportGeometry, supportMaterial);
                support.position.set(x, 5, 0);
                infrastructureObjects.push(support);
                scene.add(support);
            });
            
            bridge.userData = { type: 'infrastructure', id: 'bridge', data: infrastructureData };
            
            infrastructureObjects.push(bridge);
            scene.add(bridge);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            controls.update();
            
            // Animate traffic vehicles
            trafficObjects.forEach(obj => {
                if (obj.geometry instanceof THREE.BoxGeometry && obj.geometry.parameters.height === 0.5) {
                    obj.rotation.y += 0.01 * animationSpeed;
                }
            });
            
            // Animate pollution clouds
            environmentObjects.forEach(obj => {
                if (obj.geometry instanceof THREE.SphereGeometry) {
                    obj.rotation.y += 0.005 * animationSpeed;
                    obj.position.y = 6 + Math.sin(Date.now() * 0.001) * 0.5;
                }
            });
            
            renderer.render(scene, camera);
        }

        // Control functions
        function setCameraView(view) {
            switch(view) {
                case 'aerial':
                    camera.position.set(0, 100, 0);
                    controls.target.set(0, 0, 0);
                    break;
                case 'street':
                    camera.position.set(0, 5, 50);
                    controls.target.set(0, 0, 0);
                    break;
                case 'overview':
                    camera.position.set(50, 50, 50);
                    controls.target.set(0, 0, 0);
                    break;
            }
            controls.update();
        }

        function toggleLayer(layer) {
            showLayers[layer] = !showLayers[layer];
            const button = document.getElementById(`${layer}-toggle`);
            button.classList.toggle('active');
            
            switch(layer) {
                case 'traffic':
                    updateTrafficVisualization();
                    break;
                case 'environment':
                    updateEnvironmentVisualization();
                    break;
                case 'infrastructure':
                    updateInfrastructureVisualization();
                    break;
            }
        }

        function updateAnimationSpeed(speed) {
            animationSpeed = parseFloat(speed);
            document.getElementById('speed-value').textContent = speed;
        }

        function resetView() {
            setCameraView('overview');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('traffic_update', function(data) {
            trafficData = data;
            updateTrafficVisualization();
            document.getElementById('traffic-count').textContent = Object.keys(data).length;
        });

        socket.on('air_quality_update', function(data) {
            airQualityData = data;
            updateEnvironmentVisualization();
            document.getElementById('air-count').textContent = data.length;
        });

        socket.on('bridge_health_update', function(data) {
            infrastructureData = data;
            updateInfrastructureVisualization();
        });

        socket.on('joint_alert', function(alert) {
            alerts.unshift(alert);
            if (alerts.length > 20) alerts = alerts.slice(0, 20);
            document.getElementById('alert-count').textContent = alerts.length;
        });

        // Mouse interaction
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const tooltip = document.getElementById('tooltip');

        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects([...trafficObjects, ...environmentObjects, ...infrastructureObjects]);

            if (intersects.length > 0) {
                const object = intersects[0].object;
                if (object.userData.type) {
                    showTooltip(event, object.userData);
                } else {
                    hideTooltip();
                }
            } else {
                hideTooltip();
            }
        }

        function showTooltip(event, userData) {
            let content = '';
            
            switch(userData.type) {
                case 'traffic':
                    content = `
                        <strong>Traffic Sensor: ${userData.id}</strong><br>
                        Vehicles: ${userData.data.vehicle_count || 0}<br>
                        Speed: ${Math.round(userData.data.average_speed || 0)} km/h<br>
                        Congestion: ${Math.round((userData.data.congestion_level || 0) * 100)}%
                    `;
                    break;
                case 'environment':
                    content = `
                        <strong>Air Quality: ${userData.id}</strong><br>
                        PM2.5: ${userData.data.pm25.toFixed(1)} ¬µg/m¬≥<br>
                        NO2: ${userData.data.no2.toFixed(1)} ¬µg/m¬≥<br>
                        CO: ${userData.data.co.toFixed(1)} ppm
                    `;
                    break;
                case 'infrastructure':
                    content = `
                        <strong>Infrastructure: ${userData.id}</strong><br>
                        Status: ${userData.data.overall_status || 'Unknown'}<br>
                        Concerns: ${userData.data.concern_count || 0}<br>
                        Critical: ${userData.data.critical_concerns || 0}
                    `;
                    break;
            }
            
            tooltip.innerHTML = content;
            tooltip.style.left = event.clientX + 10 + 'px';
            tooltip.style.top = event.clientY + 10 + 'px';
            tooltip.style.display = 'block';
        }

        function hideTooltip() {
            tooltip.style.display = 'none';
        }

        // Event listeners
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initialize when page loads
        window.addEventListener('load', () => {
            setTimeout(init3DScene, 1); // Small delay for loading effect
        });
    </script>
</body>
</html>
